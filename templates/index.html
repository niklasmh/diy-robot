<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap" rel="stylesheet" />
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>
  </head>
  <style>
    body {
      font-family: "Open Sans";
      background-color: #1e1e1eee;
    }
    button,
    input {
      font-size: 3rem;
      max-width: 480px;
      width: 100%;
    }
    img {
      max-width: 480px;
      min-width: 240px;
      image-rendering: pixelated;
    }
  </style>
  <body class="min-h-screen py-1 text-gray-300">
    <div id="app"></div>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-json.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types@15.7.2/prop-types.js" crossorigin></script>
    <script src="https://unpkg.com/state-local@1.0.7/lib/umd/state-local.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" data-type="module">
      function Button({ label, color = "bg-blue-500", ...props }) {
        return (
          <button className={color + " hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"} {...props}>
            {label}
          </button>
        );
      }

      function ArmController({ onJointUpdate, jointRotations }) {
        const canvasRef = React.useRef();
        const [ctx, setCtx] = React.useState(null);
        const [mouseIsDown, setMouseIsDown] = React.useState(false);
        const width = 512;
        const height = 512;
        const cm = width / 100;
        const [pos, setPos] = React.useState({ x: 0, y: 50 * cm });

        React.useEffect(() => {
          if (canvasRef.current) {
            setCtx(canvasRef.current.getContext("2d"));
          }
        }, []);

        const sin = (x) => Math.sin((x * Math.PI) / 180);
        const cos = (x) => Math.cos((x * Math.PI) / 180);

        React.useEffect(() => {
          if (ctx) {
            const cx = 50 * cm;
            const cy = 100 * cm;

            ctx.fillStyle = "#000";
            ctx.strokeStyle = "#ddd";
            ctx.strokeWeight = 5;

            ctx.beginPath();
            ctx.fillRect(0, 0, width, height);

            ctx.moveTo(cx, cy);
            ctx.lineTo(cx - 50 * cm * sin(jointRotations[0]), cy - 50 * cm * cos(jointRotations[0]));
            ctx.stroke();
          }
        }, [ctx, jointRotations]);

        function setMousePosition({ clientX, clientY }) {
          if (mouseIsDown) {
            const { left, top } = canvasRef.current.getBoundingClientRect();
            const x = ((clientX - left - width / 2) * 100) / width;
            const y = ((height - (clientY - top)) * 100) / height;
            setPos({ x, y });
          }
        }

        React.useEffect(() => {
          // TODO: Calc IV Kinematics
          const { x, y } = pos;
          onJointUpdate(0, Math.min(90, Math.max(-90, (Math.atan2(y, x) * 180) / Math.PI - 90)));
        }, [pos]);

        const style = {
          width,
          height,
        };

        return (
          <canvas
            onMouseDown={() => setMouseIsDown(true)}
            onMouseUp={() => setMouseIsDown(false)}
            onMouseMove={setMousePosition}
            ref={canvasRef}
            width={width}
            height={height}
            style={style}
          ></canvas>
        );
      }

      function App() {
        const positionRef = React.useRef();
        const lowerRef = React.useRef();
        const upperRef = React.useRef();
        const cameraRef = React.useRef();
        const cannyCameraRef = React.useRef();
        const socket = React.useRef();
        const [realtimeRotation1, setRealtimeRotation1] = React.useState(0);
        const [realtimeRotation2, setRealtimeRotation2] = React.useState(0);
        const [realtimeRotation3, setRealtimeRotation3] = React.useState(0);

        function refreshImage() {
          if (cameraRef.current) cameraRef.current.src = "/static/camera.png?" + +new Date();
          if (cannyCameraRef.current) cannyCameraRef.current.src = "/static/canny_camera.png?" + +new Date();
        }

        React.useEffect(() => {
          socket.current = io();
          refreshImage();
          socket.current.on("position", (position) => {
            position.current.value = position;
            refreshImage();
          });
          socket.current.on("position-failed", (message) => {
            console.log(message);
            refreshImage();
          });
        }, []);

        React.useEffect(() => {
          sendMoveCommand(0, 1, realtimeRotation1);
        }, [realtimeRotation1]);

        React.useEffect(() => {
          sendMoveCommand(1, 1, realtimeRotation2);
        }, [realtimeRotation2]);

        React.useEffect(() => {
          sendMoveCommand(2, 1, realtimeRotation3);
        }, [realtimeRotation3]);

        function sendMoveCommand(motor, scale = 1, value = null) {
          const prefix = scale < 0 ? "-" : "";
          const position = value ?? positionRef.current.value;
          socket.current.emit("move", prefix + position + "," + motor);
        }
        function locate() {
          socket.current.emit("locate");
        }
        function relocate() {
          const lower = lowerRef.current.value.replace(",", ".");
          const upper = upperRef.current.value.replace(",", ".");
          socket.current.emit("relocate", lower + "," + upper);
        }

        return (
          <div className="container flex flex-col gap-8 mx-auto pb-20">
            <input ref={positionRef} defaultValue={10} min={0} max={100} type="number" />
            <input
              onChange={(e) => {
                setRealtimeRotation1(e.target.value);
              }}
              value={realtimeRotation1}
              min={-135}
              max={135}
              type="number"
            />
            <input
              onChange={(e) => {
                setRealtimeRotation2(e.target.value);
              }}
              value={realtimeRotation2}
              min={-135}
              max={135}
              type="number"
            />
            <input
              onChange={(e) => {
                setRealtimeRotation3(e.target.value);
              }}
              value={realtimeRotation3}
              min={-135}
              max={135}
              type="number"
            />
            <ArmController
              onJointUpdate={(joint, rotation) => {
                if (joint === 0) {
                  setRealtimeRotation1(Math.floor(rotation));
                }
                if (joint === 1) {
                  setRealtimeRotation2(Math.floor(rotation));
                }
                if (joint === 2) {
                  setRealtimeRotation3(Math.floor(rotation));
                }
              }}
              jointRotations={[realtimeRotation1, realtimeRotation2, realtimeRotation3]}
            />
            {/*<Button onClick={() => sendMoveCommand(0, 1)} label="Move 0 up" />
            <Button onClick={() => sendMoveCommand(0, -1)} label="Move 0 down" />
            <Button onClick={() => sendMoveCommand(1, 1)} label="Move 1 up" />
            <Button onClick={() => sendMoveCommand(1, -1)} label="Move 1 down" />
            <br />
            <Button onClick={() => locate()} label="Locate" />
            <br />
            <input ref={lowerRef} defaultValue={40} type="number" />
            <input ref={upperRef} defaultValue={20} type="number" />
            <Button onClick={() => relocate()} label="Relocate" />
            <br />
            <img ref={cameraRef} src="/static/camera.png" />
            <img ref={cannyCameraRef} src="/static/canny_camera.png" />*/}
          </div>
        );
      }

      ReactDOM.render(<App className="" />, document.querySelector("#app"));
    </script>
  </body>
</html>
